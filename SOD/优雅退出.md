生命周期结束（End-of-Lifecycle）的问题会使任务、服务以及程序的设计和实现等过程变得复杂，而这个在程序设计中非常重要的要素却经常被忽略。一个在行为良好的软件与勉强运行的软件之间的最主要区别就是，行为良好的软件能很完善地处理失败、关闭和取消等过程。

# 背景

发现k8s上的脚本服务，对于容器的退出信号没有进行处理。

在消费kafka同步ES的脚本中，导致的结果是：

- 数据丢失。消费kafka消息的时候，同步ES的脚本，为了较少同步ES的操作，会缓存一定量的数据，然后再批量进行同步。当某一部分数据缓存在程序内存中的时候，如果程序收到退出的信号，但是没有处理这批内存中的数据的话，会造成数据的丢失。

- 数据延迟。程序退出如果没有主动close掉kafka消费者，则不能立刻关闭网络连接和套接字。如果主动关闭的话，它还将立即触发重新平衡，而不是等待组协调器发现使用者停止发送心跳信号，并且很可能已死亡，这将花费更长的时间。从而导致使用者较长时间无法使用来自分区子集的消息。


# 常见的signal

### SIGHUP(1)
检测到控制中断挂起或者控制进程死亡时，进程会收到 SIGHUP。现在操作系统，该信号通常意味着使用的 虚拟终端 已经被关闭。许多 守护进程 在接收到该信号时，会重载他们的设置和重新打开日志文件（logfiles），而不是去退出程序。nohup 命令用于无视该信号。

例如： `kill -SIGHUP $(pidof dockerd)`可以看到docker守护程序收到此信号并重新加载daemon.json配置文件。因此，在修改/etc/docker/daemon.json文件后，可以向Docker发送SIGHUP信号以重新加载配置文件，而无需重新启动docker守护程序。

### SIGINT(2)
当用户希望中断进程时，SIGINT信号由用户的控制终端发送到进程。这通常通过按下Ctrl+C来发送，但是在某些系统中，可以使用“DELETE”键或“BREAK”键。

### SIGKILL(9)
发送SIGKILL信号到一个进程可以使其立即终止(KILL)。与SIGTERM和SIGINT相不同的是，这个信号不能被捕获或忽略，接收过程在接收到这个信号时不能执行任何清理。

### SIGTERM(15)
程序结束(terminate)信号, 与SIGKILL不同的是该信号可以被阻塞和处理 。通常用来要求程序自己正常退出，shell命令kill缺省产生这个信号。如果进程终止不了，我们才会尝试SIGKILL。


# timeout

timeout -s 15 -k 10 3 python cli/update_test.py

```shell script
-s 15:  --signal=SIGNAL 见'kill -l'。默认是SIGTERM
-k 10:  --kill-after=DURATION 10 在发送信号10秒钟后还是允许则直接kill掉。如果不加，则不会强制kill掉，即使处理信号的时间会很久。
3: 3秒timeout时间限制
```

# supervisor

# docker

当我们使用docker stop命令停止容器时，默认情况下，docker允许容器中的应用程序有10秒的时间来终止应用程序。我们可以通过在执行docker stop命令时手动指定--time/-t参数来定制停止的时间

执行docker stop命令时，会向容器中PID为1（主进程）的进程发送系统信号SIGTERM。然后等待容器中的应用程序终止执行。如果等待时间达到设置的超时时间，如默认的10秒，则继续发送SIGKILL的系统信号，强制终止进程。容器中的应用程序可以选择忽略而不处理SIGTERM信号，但一旦超时，程序将被系统强制终止。

默认情况下，docker kill命令不会给容器中的应用程序提供任何优雅的关闭机会。它将直接发送SIGKILL的系统信号，强制容器中的程序操作终止。
`docker kill --signal=SIGINT container_name`但与docker stop命令不同，docker kill没有任何超时设置。

docker rm命令用于删除已停止运行的容器。我们可以添加--force或-f参数来强制删除正在运行的容器。使用此参数后，docker会向正在运行的容器发送一个SIGKILL信号，强制容器停止运行，然后将其删除。


# k8s

通常情况下，容器运行时会发送一个 TERM 信号到每个容器中的主进程。 一旦超出了体面终止限期，容器运行时会向所有剩余进程发送 KILL 信号，之后 Pod 就会被从 API 服务器 上移除。

执行顺序如下：
1. 执行停止前钩子（如果配置了的话）， 然后等待它执行完毕
2. 向容器的主进程发送SIGTERM信号
3. 等待容器优雅地关闭或者等待终止宽限期超时
4. 如果容器主进程没有优雅地关闭， 使用SIGKILL信号强制终止进程

![](.优雅退出_images/613d0c3a.png)


# 常见的坑

当CMD指令执行时，shell 格式 CMD command param1 param2 底层会调用 /bin/sh -c【command】。推荐使用Exec格式：`CMD ["executable","paraml","param2"]`



