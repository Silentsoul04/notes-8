# 机器配置(2020-04-18)

5节点、1副本、 

每个节点8G内存、200G 、40G内存

已使用：5.8G JVM、128.3G

价格大概为4k

Nodes: 5
Indices: 89
Memory: 23GB / 37GB
Total Shards: 375
Unassigned Shards: 0
Documents: 996,944,007
Data: 621GB
Uptime: 8 months
Version: 5.5.3
Health: Health: green Green
Disk Available: 277GB / 984GB  (28.10%)
JVM Heap: 69.85%  (26GB / 37GB)

advertisement索引配置:

number_of_shards:5个分片

refresh_interval： 20s


克隆一个比较低配的完整的实例需要216块

---
# 自定义map reduce函数

```
GET advertisement/data/_search
{
  "query": {
    "bool": {
      "filter": [{
        "terms": {
          "channel_id": [
            "102"
          ]
        }
      },
      {
        "terms": {
          "_id": ["1670970", "5515605", "6213612"]
        }
      },
      {
        "terms": {
          "log_summary_list": ["2019-02-14"]
        }
      }
      ]
    }
  },
  "size": 0,
  "_source": ["tag_list"], 
  "aggs": {
    "profit": {
      "scripted_metric": {
        "init_script": "params._agg.transactions = new HashMap()",
        "map_script": "params._agg.transactions = ['1':1]",
        "combine_script": "return params._agg",
        "reduce_script": "return 1;"
      }
    }
  }
}

```

`"map_script": "params._agg.transactions = ['1':1]"`
里面的key是数值会偶尔报 ClassCastException:null异常


---
# cross_fields 得到负数的分数

```
GET ag_advertisement_test/data/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "multi_match": {
              "type": "cross_fields", 
              "query": "桃子 苹果", 
              "operator": "and", 
              "fields": [
                  "slogan.raw", 
                  "description.raw",
                  "ocr_video_word_list.raw",
                  "ocr_image_word_list.raw"
              ]
          }
        }
      ]
    }
  }
}
```
数据：
```text
{
  "description": null,
  "ocr_video_word_list": [],
  "ocr_image_word_list": [
    "orange",
    "eac",
    "banana",
    "偶润",
    "桃子",
    "艾坡",
    "苹果",
    "桔子",
    "香蕉"
  ],
  "slogan": "这样学英语太有趣啦！3天搞定500个单词！"
}

```

* 问题分析:
    ocr_video_word_list 、ocr_image_word_list 是数组，导致跟slogan这些类型组合的时候有问题

* 解决办法：
    按类型分来进行cross_fields查询

https://github.com/elastic/elasticsearch/pull/35865



---
# highlight异常
例子：

```
GET advertisement/data/_search
{
    "size": 60, 
    "highlight": {
        "require_field_match": true, 
        "pre_tags": [
            "<em class=\"highlight\">"
        ], 
        "fields": {
            "*": { }
        }, 
        "post_tags": [
            "</em>"
        ], 
        
        "number_of_fragments": 0
    }, 
    "_source": [
        "slogan"
    ], 
    "from": 0, 
    "query": {
        "function_score": {
            "query": {
                "bool": {
                    "should": [
                        {
                            "multi_match": {
                                "operator": "or", 
                                "type": "best_fields", 
                                "fields": "slogan^128", 
                                "query": "七猫免费小说", 
                                "tie_breaker": 1, 
                                "minimum_should_match": "100%"
                            }
                        }
                    ], 
                    "minimum_should_match": 0, 
                    "filter": [
                        {
                            "terms": {
                                "_id": [
                                    10429603
                                ]
                            }
                        }
                    ]
                }
            }, 
            "boost_mode": "sum", 
            "score_mode": "max", 
            "functions": [ ]
        }
    }, 
    "sort": [
        {
            "_score": "desc"
        }, 
        {
            "updatedAt": "desc"
        }
    ], 
    "min_score": 0
}

{
  "took": 5,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "failed": 0
  },
  "hits": {
    "total": 1,
    "max_score": null,
    "hits": [
      {
        "_index": "advertisement_v6.5.1",
        "_type": "data",
        "_id": "10429603",
        "_score": 0,
        "_routing": "1b7b41902751fb952202366795ecabc3",
        "_parent": "1b7b41902751fb952202366795ecabc3",
        "_source": {
          "slogan": "边看小说边赚钱，看了15分钟就赚了30块！"
        },
        "highlight": {
          "slogan": [
            """边看<em class="highlight">小说</em>边赚钱，看了15分钟就赚了30块！"""
          ]
        },
        "sort": [
          0,
          1557745262000
        ]
      }
    ]
  }
}
```


分析： score为0分，表示并没有命中查询规则，但是还是进行字段的高亮?

https://github.com/elastic/elasticsearch/issues/6787

---
# 重叠不高亮

这是因为ES的本身限制是导致的。“看这里”拆成了"看这"、“这里”，两个都匹配了，但是这两个词有重叠了，所以只高亮了第一个。

问题分析: his behavior is due to the way FastVectorHighlighter discards matches that have overlapping offsets

解决办法：
1. 优化关键词库的时候把“看这里”、“常用”等一些重叠的但是有含义的词收录到关键词库里？
2. edge ngram tokenizer
 
- https://jira.umlife.net/browse/AG-3182?filter=11617

- https://stackoverflow.com/questions/49096468/elasticsearch-highlighter-false-positives

- https://github.com/elastic/elasticsearch/issues/2824#issuecomment-18500114

- https://github.com/elastic/elasticsearch/issues/10071   

---
# 自定义桶聚合

```
GET advertisement_v5.3/slogan_data/_search
{
  "size": 0,
  "query": {
    "range": {
      "updatedAt": {
        "gte": "2018-11-01 00:00:00",
        "lte": "2018-12-20 00:00:00"
      }
    }
  },
  "aggs": {
    "N1": {
      "nested": {
        "path": "tag_list"
      },
      "aggs": {
        "N2": {
          "terms": {
            "field": "tag_list.tagid",
            "size": 100,
            "order": {
              "N3>N4": "asc"
            }
          },
          "aggs": {
            "N6": {
              "bucket_script": {
                "buckets_path": {
                  "v1":"N3>N4",
                  "v2":"N5"
                },
                "script": "params.v1*params.v2"
              }
            }, 
            "N5": {
              "sum": {
                "field": "tag_list.method"
              }
            },
            "N3": {
              "reverse_nested": {
              },
              "aggs": {
                "N4": {
                  "cardinality": {
                    "script": {
                      "inline": "List x = new ArrayList(); for (v in doc['log_list']) {if (v >= 1541030400000L && v < 1545264000000L) {x.add(v)}} return x;"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}

```
